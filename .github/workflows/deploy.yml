name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-migrations:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest
    # Only deploy if CI workflow succeeded on main, or if manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./code
        run: pnpm install --frozen-lockfile

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        working-directory: ./code
        run: pnpm --filter backend db:migrate

  deploy-backend:
    name: Deploy Backend API
    runs-on: ubuntu-latest
    # Only deploy if CI workflow succeeded on main, or if manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    needs: deploy-migrations # Run migrations first
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./code
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        working-directory: ./code
        run: pnpm --filter @zadoox/shared build

      - name: Build backend
        working-directory: ./code
        run: pnpm --filter backend build

      - name: Railway deployment info
        run: |
          echo "ℹ️ Backend deployment is handled by Railway's GitHub integration"
          echo "Railway will automatically deploy on push to main branch"
          echo "Migrations are run via this workflow before Railway deployment"

  deploy-web:
    name: Deploy Web App to Vercel
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Install dependencies
        working-directory: ./code
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        working-directory: ./code
        run: pnpm --filter @zadoox/shared build

      - name: Link Vercel project
        working-directory: ./code/packages/web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "Linking Vercel project..."
          vercel link --yes --token=$VERCEL_TOKEN --project=$VERCEL_PROJECT_ID --scope=$VERCEL_ORG_ID
          
          echo "Pulling project settings to sync configuration..."
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          
          echo "Verifying package.json is present..."
          if [ ! -f "package.json" ]; then
            echo "❌ ERROR: package.json not found in current directory"
            echo "Current directory: $(pwd)"
            ls -la
            exit 1
          fi
          
          echo "Verifying Next.js dependency..."
          if ! grep -q '"next"' package.json; then
            echo "❌ ERROR: Next.js not found in package.json dependencies"
            exit 1
          fi
          echo "✅ Next.js found in package.json"

      - name: Deploy to Vercel
        working-directory: ./code/packages/web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          SKIP_ENV_VALIDATION: "1"
        run: |
          echo "Deploying to Vercel..."
          echo "Current directory: $(pwd)"
          echo "Verifying project structure..."
          
          if [ ! -f "package.json" ]; then
            echo "❌ ERROR: package.json not found"
            exit 1
          fi
          
          if [ ! -f "vercel.json" ]; then
            echo "❌ ERROR: vercel.json not found"
            exit 1
          fi
          
          echo "✅ Project files found"
          echo "Package.json contents (first 20 lines):"
          head -20 package.json
          
          echo "Deploying with vercel deploy --prod..."
          vercel deploy --prod --token=$VERCEL_TOKEN --yes
