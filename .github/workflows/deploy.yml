name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-migrations:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest
    # Only deploy if CI workflow succeeded on main, or if manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./code
        run: pnpm install --frozen-lockfile

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        working-directory: ./code
        run: pnpm --filter backend db:migrate

  deploy-backend:
    name: Deploy Backend API
    runs-on: ubuntu-latest
    # Only deploy if CI workflow succeeded on main, or if manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    needs: deploy-migrations # Run migrations first
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./code
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        working-directory: ./code
        run: pnpm --filter @zadoox/shared build

      - name: Build backend
        working-directory: ./code
        run: pnpm --filter backend build

      - name: Railway deployment info
        run: |
          echo "ℹ️ Backend deployment is handled by Railway's GitHub integration"
          echo "Railway will automatically deploy on push to main branch"
          echo "Migrations are run via this workflow before Railway deployment"

  deploy-web:
    name: Deploy Web App to Vercel
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Install dependencies
        working-directory: ./code
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        working-directory: ./code
        run: pnpm --filter @zadoox/shared build

      - name: Link Vercel project
        working-directory: ./code/packages/web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "Linking Vercel project..."
          vercel link --yes --token=$VERCEL_TOKEN --project=$VERCEL_PROJECT_ID --scope=$VERCEL_ORG_ID

      - name: Pull Vercel environment
        working-directory: ./code/packages/web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Pulling environment variables..."
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          
          echo "Verifying environment variables were pulled..."
          if [ -f ".vercel/.env.production.local" ]; then
            echo "✅ Environment file created"
            echo "Environment variables in file:"
            grep -E "^[A-Z]" .vercel/.env.production.local | sed 's/=.*/=***/' || echo "No vars found"
            
            # Copy to .env.production.local so Next.js can load it during build
            echo "Copying .vercel/.env.production.local to .env.production.local for Next.js..."
            cp .vercel/.env.production.local .env.production.local
            echo "✅ Environment file copied for Next.js build"
          else
            echo "❌ ERROR: .vercel/.env.production.local not found!"
            echo "Make sure environment variables are set in Vercel project settings"
            exit 1
          fi

      - name: Build with Vercel
        working-directory: ./code/packages/web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Building with Vercel CLI..."
          echo "Current directory: $(pwd)"
          
          # Export environment variables from .env.production.local
          if [ -f ".env.production.local" ]; then
            echo "✅ .env.production.local exists"
            echo "Exporting environment variables..."
            set -a
            source .env.production.local
            set +a
            echo "Environment variables exported"
            # Verify they're set
            if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ] || [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then
              echo "❌ ERROR: Required environment variables not found in .env.production.local"
              echo "NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:+SET}"
              echo "NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:+SET}"
              exit 1
            fi
            echo "✅ Required environment variables are set"
          else
            echo "❌ ERROR: .env.production.local not found!"
            exit 1
          fi
          
          echo "Running vercel build --prod..."
          # Run vercel build and capture output
          # The exported env vars will be available to the build process
          set -e
          vercel build --prod --token=$VERCEL_TOKEN --yes
          
          echo "Build command completed. Checking for output..."
          echo "Contents of current directory:"
          ls -la
          echo "Contents of .vercel directory:"
          ls -la .vercel/ 2>&1 || echo "No .vercel directory"
          
          if [ -d ".vercel/output" ]; then
            echo "✅ .vercel/output found!"
            ls -la .vercel/output/ | head -10
          else
            echo "❌ ERROR: .vercel/output not found after build!"
            echo "Checking for .next directory:"
            ls -la .next 2>&1 || echo "No .next directory"
            exit 1
          fi

      - name: Deploy to Vercel
        working-directory: ./code/packages/web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Deploying prebuilt output..."
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN --yes
